<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Community Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center items-center">
  <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg flex h-[90vh]">

    <!-- LEFT: CONTACTS -->
    <div class="w-1/3 border-r flex flex-col">
      <!-- Header with single profile icon (current user) -->
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <!-- Left side: User Avatar + Contacts text -->
        <div class="flex items-center gap-3">
          <div id="userAvatar"
              class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold cursor-pointer"
              title="Click to set Unique Key"
              onclick="openModal()"></div>
          <h2 class="text-lg font-semibold">Contacts</h2>
        </div>

        <!-- Right side: Menu button -->
        <div class="relative">
          <button id="menuBtn"
                  class="p-2 rounded-full hover:bg-gray-100 focus:outline-none"
                  onclick="toggleMenu()">
            ⋮
          </button>
          <!-- Dropdown Menu -->
          <div id="menuDropdown"
              class="hidden absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg z-10">
            <button onclick="addNewUser()"
                    class="block w-full text-left px-4 py-2 hover:bg-gray-100">
              Add new user
            </button>
            <button onclick="showNotifications()"
                    class="block w-full text-left px-4 py-2 hover:bg-gray-100">
              Notification
            </button>
          </div>
        </div>
      </div>

      <!-- Contacts list -->
      <div id="contacts" class="flex-1 overflow-y-auto"></div>
    </div>

    <!-- RIGHT: CHAT -->
    <div class="flex-1 flex flex-col">
      <!-- Chat Header -->
      <div class="px-4 py-3 border-b flex items-center gap-2">
        <h2 id="chat-with" class="text-lg font-semibold text-gray-700">Select a contact</h2>
      </div>

      <!-- Messages -->
      <div id="output" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"></div>

      <!-- Input -->
      <div class="p-3 border-t flex items-center gap-2">
        <input id="messageInput" type="text" placeholder="Type a message..."
               class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring focus:ring-blue-300" />
        <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full">➤</button>
      </div>
    </div>
  </div>
  <!-- Add New User Modal -->
  <div id="addUserModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-xl font-semibold mb-4">Add New User</h2>

      <label class="block mb-2 text-sm font-medium">Username</label>
      <input id="newUsername" type="text"
            class="w-full px-3 py-2 border rounded mb-4"
            placeholder="Enter username">

      <label class="block mb-2 text-sm font-medium">Key</label>
      <input id="newUserKey" type="text"
            class="w-full px-3 py-2 border rounded mb-4"
            placeholder="Enter key">

      <div id="addUserMessage" class="text-sm mb-3"></div>

      <div class="flex justify-end gap-3">
        <button onclick="closeAddUserModal()"
                class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
        <button onclick="connectUser()"
                class="px-4 py-2 bg-blue-600 text-white rounded">Connect</button>
      </div>
    </div>
  </div>
  <!-- Hidden user and contacts data injected by FastAPI/Jinja -->
  <h2 id="username" class="hidden">{{ user }}</h2>
  <script id="contacts-data" type="application/json">{{ contacts | tojson }}</script>

  <!-- MODAL for Unique Key (opens only on avatar click) -->
  <div id="uniqueKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg w-96 p-6">
      <h2 class="text-lg font-semibold mb-4">Enter your Unique Key</h2>
      <input id="uniqueKeyInput" type="text" placeholder="Unique Key"
             class="w-full border px-3 py-2 rounded mb-4 focus:outline-none focus:ring focus:ring-blue-300" />
      <div class="flex justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
        <button onclick="saveUniqueKey()" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
      </div>
      <p id="modalMessage" class="text-sm mt-3"></p>
    </div>
  </div>

  <script>
    let ws;
    let currentUser;
    let activeChatUser = null;

    window.onload = () => {
      currentUser = document.getElementById("username").innerText.trim();
      if (!currentUser) {
        alert("No user found.");
        return;
      }

      // Set avatar initial in header (single avatar)
      const avatarEl = document.getElementById("userAvatar");
      avatarEl.innerText = currentUser.charAt(0).toUpperCase();

      // Render contacts list
      const contactsData = JSON.parse(document.getElementById("contacts-data").textContent || "[]");
      renderContacts(contactsData);

      // Connect websocket
      connect(currentUser);
    };

    // Render contact rows (no modal on contact click)
    function renderContacts(contacts) {
      const contactsDiv = document.getElementById("contacts");
      contactsDiv.innerHTML = "";

      contacts.forEach(contact => {
        const contactEl = document.createElement("div");
        contactEl.className =
          "px-4 py-3 hover:bg-gray-100 cursor-pointer border-b flex items-center gap-3";

        // small avatar/initial for list preview
        const avatar = document.createElement("div");
        avatar.className = "w-8 h-8 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold";
        avatar.innerText = contact.charAt(0).toUpperCase();

        const name = document.createElement("span");
        name.className = "font-medium";
        name.innerText = contact;

        contactEl.appendChild(avatar);
        contactEl.appendChild(name);

        // When a contact is clicked: set active, update header, clear chat, POST for history
        contactEl.onclick = () => {
          activeChatUser = contact;
          document.getElementById("chat-with").innerText = contact;
          document.getElementById("output").innerHTML = "";
          loadChatHistory(currentUser, contact); // POST request (your original style)
        };

        contactsDiv.appendChild(contactEl);
      });
    }

    // POST /chat-history with { user, contact } (original style you used)
    async function loadChatHistory(user, contact) {
      try {
        const response = await fetch("/chat-history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: user, contact: contact })
        });

        if (response.ok) {
          const history = await response.json(); // expected: [(username, msg), ...]
          renderChatHistory(history);
        } else {
          console.error("Failed to load chat history:", response.status, await response.text());
        }
      } catch (err) {
        console.error("Error fetching chat history:", err);
      }
    }

    // Render history into chat window
    function renderChatHistory(history) {
      const output = document.getElementById("output");
      output.innerHTML = "";

      // history expected as array of [sender, message]
      history.forEach(pair => {
        // defensive destructuring in case server returns arrays vs tuples
        const sender = pair[0];
        const message = pair[1];
        appendMessage(sender, message);
      });

      output.scrollTop = output.scrollHeight;
    }

    // Modal functions (ONLY avatar opens modal)
    function openModal() {
      document.getElementById("uniqueKeyModal").classList.remove("hidden");
      document.getElementById("uniqueKeyInput").value = "";
      document.getElementById("modalMessage").innerText = "";
    }
    function closeModal() {
      document.getElementById("uniqueKeyModal").classList.add("hidden");
    }

    // Save unique key for current user (POST to /save-unique-id)
    async function saveUniqueKey() {
      const uniqueId = document.getElementById("uniqueKeyInput").value.trim();
      const messageEl = document.getElementById("modalMessage");

      if (!uniqueId) {
        messageEl.innerText = "Unique Key is required!";
        messageEl.className = "text-sm text-red-600 mt-3";
        return;
      }

      try {
        const res = await fetch("/save-unique-id", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: currentUser, unique_id: uniqueId })
        });

        if (res.ok) {
          const data = await res.json();
          if (data.success) {
            messageEl.innerText = "Changes have been saved.";
            messageEl.className = "text-sm text-green-600 mt-3";
            setTimeout(() => closeModal(), 900);
          } else {
            messageEl.innerText = "ID already exists.";
            messageEl.className = "text-sm text-red-600 mt-3";
          }
        } else {
          messageEl.innerText = "Server error.";
          messageEl.className = "text-sm text-red-600 mt-3";
          console.error("save-unique-id failed:", res.status, await res.text());
        }
      } catch (err) {
        messageEl.innerText = "Error saving unique key.";
        messageEl.className = "text-sm text-red-600 mt-3";
        console.error("saveUniqueKey error:", err);
      }
    }

    // WebSocket connect
    function connect(userId) {
      try {
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${protocol}://${window.location.host}/ws/${userId}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => console.log("WebSocket connected:", wsUrl);
        ws.onmessage = (event) => {
          // server sends "sender: message"
          const [sender, ...messageParts] = event.data.split(":");
          const messageText = messageParts.join(":").trim();

          // Append only if relevant to current open chat OR it's the current user (so you still see your sent messages)
          // If you prefer to always append broadcasts, remove the if-check below.
          const senderTrim = sender.trim();
          if (senderTrim === currentUser || senderTrim === activeChatUser) {
            appendMessage(senderTrim, messageText);
          }
        };
        ws.onerror = (e) => console.error("WebSocket error:", e);
        ws.onclose = () => console.log("WebSocket closed");
      } catch (err) {
        console.error("WS connect error:", err);
      }
    }

    // Send message via WebSocket (same behaviour as before)
    function sendMessage() {
      const msgInput = document.getElementById("messageInput");
      const msg = msgInput.value.trim();
      if (!msg) return alert("Type a message.");
      if (!activeChatUser) return alert("Please select a contact first.");

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ to: activeChatUser, msg })); // backend expects raw message text
        appendMessage(currentUser, msg);
        msgInput.value = "";
      } else {
        alert("WebSocket is not connected.");
      }
    }

    // Append message into chat window with correct alignment/colors
    function appendMessage(sender, messageText) {
      const output = document.getElementById("output");
      const wrapper = document.createElement("div");

      if (sender === currentUser) {
        wrapper.className = "flex justify-end mb-2";
      } else {
        wrapper.className = "flex justify-start mb-2";
      }

      const bubble = document.createElement("div");
      bubble.className = sender === currentUser
        ? "bg-blue-600 text-white px-4 py-2 rounded-2xl max-w-sm"
        : "bg-gray-200 text-gray-800 px-4 py-2 rounded-2xl max-w-sm";

      // optionally hide sender label for self messages if you like
      bubble.innerHTML = `
        <p class="text-xs font-semibold mb-1">${sender}</p>
        <p>${escapeHtml(messageText)}</p>
      `;

      wrapper.appendChild(bubble);
      output.appendChild(wrapper);
      output.scrollTop = output.scrollHeight;
    }

    // small helper to avoid raw HTML injection
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function toggleMenu() {
      const dropdown = document.getElementById("menuDropdown");
      dropdown.classList.toggle("hidden");
    }

    // Example handlers
    function addNewUser() {
      openAddUserModal();
      toggleMenu();
    }

    function showNotifications() {
      alert("Notification clicked!");
      toggleMenu();
    }

    // Close menu if clicked outside
    window.addEventListener("click", function (e) {
      const menuBtn = document.getElementById("menuBtn");
      const dropdown = document.getElementById("menuDropdown");
      if (!menuBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add("hidden");
      }
    });

    function openAddUserModal() {
      document.getElementById("addUserModal").classList.remove("hidden");
    }

    function closeAddUserModal() {
      document.getElementById("addUserModal").classList.add("hidden");
      document.getElementById("addUserMessage").innerText = "";
    }

    async function connectUser() {
      const username = document.getElementById("newUsername").value.trim();
      const key = document.getElementById("newUserKey").value.trim();
      const messageEl = document.getElementById("addUserMessage");

      if (!username || !key) {
        messageEl.innerText = "Both fields are required.";
        messageEl.className = "text-sm text-red-600 mb-3";
        return;
      }

      try {
        const res = await fetch("/connect-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, key })
        });

        if (res.ok) {
          const data = await res.json();

          if (Array.isArray(data)) {
            // ✅ Server returned updated contacts list
            updateContactList(data);
            closeAddUserModal();
          } else {
            // ❌ Server returned False
            document.getElementById("addUserMessage").innerText =
              "Given data doesn't match any users.";
            document.getElementById("addUserMessage").className =
              "text-sm text-red-600 mt-3";
          }
        } else {
          messageEl.innerText = "Server error.";
          messageEl.className = "text-sm text-red-600 mb-3";
        }
      } catch (err) {
        console.error("connectUser error:", err);
        messageEl.innerText = "Error connecting user.";
        messageEl.className = "text-sm text-red-600 mb-3";
      }
    }

    function updateContactList(contacts) {
      renderContacts(contacts);
    }
  </script>
</body>
</html>

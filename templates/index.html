<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Chat Application</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#00D4AA',
                        secondary: '#1A1A1A'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': '8px'
                    }
                }
            }
        }
    </script>
    <style>
        .chat-bg {
            background-color: #1a1a1a;
            background-image: url('https://readdy.ai/api/search-image?query=dark%20abstract%20technology%20background%20with%20subtle%20circuit%20patterns%20and%20glowing%20lines%2C%20deep%20navy%20blue%20and%20dark%20gray%20gradient%2C%20modern%20digital%20communication%20theme%2C%20minimal%20geometric%20shapes%2C%20professional%20dark%20interface%20design%20suitable%20for%20messaging%20app&width=1400&height=900&seq=chatbg004&orientation=landscape');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        .chat-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-gray-900 h-screen overflow-hidden">
    <div class="flex flex-col h-screen">
        <!-- Main Header -->
        <header class="bg-gray-800 text-white px-4 py-3 md:px-6 md:py-3 flex items-center justify-between border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div class="font-['Pacifico'] text-xl md:text-2xl text-primary">Whispr</div>
                <div class="flex items-center gap-2 md:gap-3">
                    <div class="w-8 h-8 md:w-9 md:h-9 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold cursor-pointer"
                         onclick="openUniqueKeyModal()">
                        <i class="ri-user-line text-gray-300 text-sm md:text-base"></i>
                    </div>
                    <span class="text-base md:text-lg font-medium" id="username">{{ user }}</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center hover:bg-gray-700 rounded-full transition-colors">
                    <i class="ri-notification-line text-sm md:text-lg"></i>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar - Contacts List -->
            <div class="w-full md:w-80 bg-gray-800 border-r border-gray-700 flex flex-col" id="sidebar">
                <div class="p-3 md:p-4 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <h2 class="text-base md:text-lg font-semibold text-white">Chats</h2>
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <button class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center hover:bg-gray-700 rounded-full transition-colors"
                                    id="settingsBtn">
                                    <i class="ri-settings-line text-gray-300 text-sm md:text-base"></i>
                                </button>
                                <div class="absolute right-0 top-9 md:top-10 bg-gray-700 border border-gray-600 rounded-lg shadow-lg py-2 w-40 md:w-48 hidden z-10"
                                    id="settingsMenu">
                                    <button onclick="openAddUserModal()"
                                        class="w-full px-3 py-2 md:px-4 md:py-2 text-left hover:bg-gray-600 flex items-center gap-2 md:gap-3 text-white text-sm md:text-base">
                                        <i class="ri-user-add-line text-gray-300 text-sm"></i>
                                        Add new user
                                    </button>
                                    <button onclick="showNotifications()"
                                        class="w-full px-3 py-2 md:px-4 md:py-2 text-left hover:bg-gray-600 flex items-center gap-2 md:gap-3 text-white text-sm md:text-base">
                                        <i class="ri-notification-line text-gray-300 text-sm"></i>
                                        Notifications
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto" id="contactsList">
                    <!-- Contacts will be dynamically rendered here -->
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col bg-gray-900 h-full hidden md:flex" id="chatArea">
                <!-- Chat Header -->
                <div class="bg-gray-800 border-b border-gray-700 px-4 py-3 md:px-6 md:py-3 flex items-center gap-3 flex-shrink-0"
                    id="chatHeader">
                    <button class="w-7 h-7 md:w-8 md:h-8 flex items-center justify-center hover:bg-gray-700 rounded-full transition-colors md:hidden"
                        id="backToContacts">
                        <i class="ri-arrow-left-line text-gray-300 text-sm"></i>
                    </button>
                    <div class="w-8 h-8 md:w-9 md:h-9 rounded-full bg-gray-600 flex items-center justify-center" id="chatContactImage">
                        <i class="ri-user-line text-gray-300 text-sm md:text-base"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-medium text-white text-sm md:text-base" id="chatContactName">Select a contact</h3>
                        <p class="text-xs text-gray-400" id="chatStatus">Offline</p>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto p-3 md:p-6 chat-bg min-h-0" id="messagesArea">
                    <div class="space-y-3 md:space-y-4 relative z-10 min-h-full" id="messagesContainer">
                        <div class="flex justify-center">
                            <div class="bg-gray-700 rounded-lg px-3 py-2 md:px-4 md:py-2">
                                <p class="text-gray-400 text-xs md:text-sm">Select a contact to start chatting</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t border-gray-700 p-3 bg-gray-800 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="flex-1 relative">
                            <input class="w-full px-3 py-2 bg-gray-700 text-white placeholder-gray-400 rounded-full focus:outline-none focus:ring-2 focus:ring-primary/20 text-sm"
                                id="messageInput" placeholder="Type a message..." type="text" />
                        </div>
                        <button class="w-10 h-10 flex items-center justify-center bg-primary hover:bg-primary/90 text-black rounded-full transition-colors !rounded-button whitespace-nowrap flex-shrink-0"
                            id="sendBtn" onclick="sendMessage()">
                            <i class="ri-send-plane-fill text-base"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden data injected by FastAPI -->
    <script id="contacts-data" type="application/json">{{ contacts | tojson }}</script>

    <!-- Unique Key Modal -->
    <div id="uniqueKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-lg w-11/12 md:w-96 p-4 md:p-6 border border-gray-700 mx-4">
            <h2 class="text-lg font-semibold text-white mb-4">Enter your Unique Key</h2>
            <input id="uniqueKeyInput" type="text" placeholder="Unique Key"
                   class="w-full border border-gray-600 bg-gray-700 text-white px-3 py-2 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base" />
            <div class="flex justify-end gap-2">
                <button onclick="closeUniqueKeyModal()" class="px-3 py-2 md:px-4 md:py-2 rounded bg-gray-600 text-white hover:bg-gray-700 transition-colors text-sm">Cancel</button>
                <button onclick="saveUniqueKey()" class="px-3 py-2 md:px-4 md:py-2 rounded bg-primary text-black hover:bg-primary/90 transition-colors text-sm">Save</button>
            </div>
            <p id="modalMessage" class="text-sm mt-3"></p>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg w-11/12 md:w-96 border border-gray-700 mx-4">
            <h2 class="text-xl font-semibold text-white mb-4">Add New User</h2>

            <label class="block mb-2 text-sm font-medium text-gray-300">Username</label>
            <input id="newUsername" type="text"
                  class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded mb-4 focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base"
                  placeholder="Enter username">

            <label class="block mb-2 text-sm font-medium text-gray-300">Key</label>
            <input id="newUserKey" type="text"
                  class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded mb-4 focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base"
                  placeholder="Enter key">

            <div id="addUserMessage" class="text-sm mb-3"></div>

            <div class="flex justify-end gap-3">
                <button onclick="closeAddUserModal()"
                        class="px-3 py-2 md:px-4 md:py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors text-sm">Cancel</button>
                <button onclick="connectUser()"
                        class="px-3 py-2 md:px-4 md:py-2 bg-primary text-black rounded hover:bg-primary/90 transition-colors text-sm">Connect</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let currentUser;
        let activeChatUser = null;
        let contacts = [];

        // Initialize application
        window.onload = () => {
            currentUser = "{{ user }}".trim();
            if (!currentUser) {
                alert("No user found.");
                return;
            }

            // Update username in header
            document.getElementById("username").textContent = currentUser;

            // Load contacts
            const contactsData = JSON.parse(document.getElementById("contacts-data").textContent || "[]");
            contacts = contactsData;
            renderContacts(contacts);

            // Connect WebSocket
            connect(currentUser);

            // Initialize UI interactions
            initializeUI();

            // Set initial mobile state
            handleMobileLayout();
        };

        // Handle mobile layout
        function handleMobileLayout() {
            const isMobile = window.innerWidth < 768;
            const sidebar = document.getElementById('sidebar');
            const chatArea = document.getElementById('chatArea');
            
            if (isMobile) {
                // On mobile, show contacts by default, hide chat
                if (!activeChatUser) {
                    sidebar.classList.remove('hidden');
                    chatArea.classList.add('hidden');
                } else {
                    sidebar.classList.add('hidden');
                    chatArea.classList.remove('hidden');
                }
            } else {
                // On desktop, show both
                sidebar.classList.remove('hidden');
                chatArea.classList.remove('hidden');
            }
        }

        // Initialize UI event listeners
        function initializeUI() {
            // Settings menu
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsMenu = document.getElementById('settingsMenu');
            if (settingsBtn && settingsMenu) {
                settingsBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    settingsMenu.classList.toggle('hidden');
                });
            }

            document.addEventListener('click', function () {
                if (settingsMenu) settingsMenu.classList.add('hidden');
            });

            if (settingsMenu) {
                settingsMenu.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }

            // Mobile navigation
            const backToContacts = document.getElementById('backToContacts');
            if (backToContacts) {
                backToContacts.addEventListener('click', function () {
                    showContactsView();
                });
            }

            // Message input enter key
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Responsive behavior
            window.addEventListener('resize', handleMobileLayout);
        }

        // Show contacts view (mobile only)
        function showContactsView() {
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('chatArea').classList.add('hidden');
                // Reset chat header to default state when going back to contacts
                resetChatHeader();
            }
        }

        // Show chat view (mobile only)
        function showChatView() {
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('chatArea').classList.remove('hidden');
            }
        }

        // Reset chat header to default state
        function resetChatHeader() {
            document.getElementById("chatContactName").textContent = "Select a contact";
            document.getElementById("chatStatus").textContent = "Offline";
            activeChatUser = null;
            
            // Clear messages
            document.getElementById("messagesContainer").innerHTML = `
                <div class="flex justify-center">
                    <div class="bg-gray-700 rounded-lg px-3 py-2 md:px-4 md:py-2">
                        <p class="text-gray-400 text-xs md:text-sm">Select a contact to start chatting</p>
                    </div>
                </div>
            `;
        }

        // Render contacts list
        function renderContacts(contacts) {
            const contactsList = document.getElementById("contactsList");
            if (!contactsList) return;

            contactsList.innerHTML = "";

            contacts.forEach(contact => {
                const contactEl = document.createElement("div");
                contactEl.className = "contact-item hover:bg-gray-700 px-3 py-2 md:px-4 md:py-3 cursor-pointer flex items-center gap-3 border-b border-gray-700";
                contactEl.setAttribute("data-contact", contact);

                const avatar = document.createElement("div");
                avatar.className = "w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-600 text-white flex items-center justify-center font-bold";
                avatar.innerHTML = `<i class="ri-user-line text-gray-300 text-sm"></i>`;

                const contactInfo = document.createElement("div");
                contactInfo.className = "flex-1 min-w-0";
                
                const name = document.createElement("h3");
                name.className = "font-medium text-white truncate text-sm md:text-base";
                name.textContent = contact;

                const lastMessage = document.createElement("p");
                lastMessage.className = "text-gray-400 truncate text-xs";
                lastMessage.textContent = "Click to start chatting";

                contactInfo.appendChild(name);
                contactInfo.appendChild(lastMessage);

                contactEl.appendChild(avatar);
                contactEl.appendChild(contactInfo);

                // Contact click handler
                contactEl.onclick = () => {
                    // Update active state
                    document.querySelectorAll('.contact-item').forEach(item => {
                        item.classList.remove('bg-primary/20', 'border-r-4', 'border-primary');
                    });
                    contactEl.classList.add('bg-primary/20', 'border-r-4', 'border-primary');

                    // Set active chat
                    activeChatUser = contact;
                    document.getElementById("chatContactName").textContent = contact;
                    document.getElementById("chatStatus").textContent = "Online";
                    
                    // Clear and load chat history
                    document.getElementById("messagesContainer").innerHTML = "";
                    loadChatHistory(currentUser, contact);

                    // Switch to chat view on mobile
                    showChatView();
                    
                    // Focus input for immediate typing
                    setTimeout(() => {
                        const messageInput = document.getElementById('messageInput');
                        if (messageInput) messageInput.focus();
                    }, 100);
                };

                contactsList.appendChild(contactEl);
            });
        }

        // Load chat history
        async function loadChatHistory(user, contact) {
            try {
                const response = await fetch("/chat-history", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user: user, contact: contact })
                });

                if (response.ok) {
                    const history = await response.json();
                    renderChatHistory(history);
                } else {
                    console.error("Failed to load chat history:", response.status, await response.text());
                }
            } catch (err) {
                console.error("Error fetching chat history:", err);
            }
        }

        // Render chat history - UPDATED for new format with timestamps
        function renderChatHistory(history) {
            const messagesContainer = document.getElementById("messagesContainer");
            if (!messagesContainer) return;

            messagesContainer.innerHTML = "";

            history.forEach(messageData => {
                // Handle both old format [sender, message] and new format [sender, message, timestamp]
                const sender = messageData[0];
                const messageText = messageData[1];
                const timestamp = messageData[2] || null; // Use provided timestamp or null if not available
                
                appendMessage(sender, messageText, timestamp);
            });

            // Scroll to bottom
            const messagesArea = document.getElementById("messagesArea");
            if (messagesArea) {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
        }

        // WebSocket connection
        function connect(userId) {
            try {
                const protocol = window.location.protocol === "https:" ? "wss" : "ws";
                const wsUrl = `${protocol}://${window.location.host}/ws/${userId}`;
                ws = new WebSocket(wsUrl);

                ws.onopen = () => console.log("WebSocket connected:", wsUrl);
                ws.onmessage = (event) => {
                    const [sender, ...messageParts] = event.data.split(":");
                    const messageText = messageParts.join(":").trim();
                    const senderTrim = sender.trim();
                    
                    if (senderTrim === currentUser || senderTrim === activeChatUser) {
                        appendMessage(senderTrim, messageText);
                    }
                };
                ws.onerror = (e) => console.error("WebSocket error:", e);
                ws.onclose = () => console.log("WebSocket closed");
            } catch (err) {
                console.error("WS connect error:", err);
            }
        }

        // Send message
        function sendMessage() {
            const msgInput = document.getElementById("messageInput");
            if (!msgInput) return;
            
            const msg = msgInput.value.trim();
            if (!msg) return;
            if (!activeChatUser) return alert("Please select a contact first.");

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ to: activeChatUser, msg }));
                appendMessage(currentUser, msg);
                msgInput.value = "";
                
                // Keep focus on input for continuous typing
                msgInput.focus();
            } else {
                alert("WebSocket is not connected.");
            }
        }

        // Append message to chat - UPDATED to handle timestamps
        function appendMessage(sender, messageText, timestamp = null) {
            const messagesContainer = document.getElementById("messagesContainer");
            if (!messagesContainer) return;

            const wrapper = document.createElement("div");

            if (sender === currentUser) {
                wrapper.className = "flex justify-end";
            } else {
                wrapper.className = "flex justify-start";
            }

            // Use provided timestamp or generate current time
            const timeString = timestamp || new Date().toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            const bubble = document.createElement("div");
            bubble.className = sender === currentUser
                ? "max-w-xs bg-primary text-black rounded-lg px-3 py-2 md:px-4 md:py-2"
                : "max-w-xs bg-gray-700 text-white rounded-lg px-3 py-2 md:px-4 md:py-2 shadow-sm";

            bubble.innerHTML = `
                <p class="text-xs font-semibold mb-1 ${sender === currentUser ? 'text-gray-800' : 'text-gray-300'}">${sender}</p>
                <p class="text-sm">${escapeHtml(messageText)}</p>
                <span class="text-xs ${sender === currentUser ? 'text-gray-800' : 'text-gray-400'} mt-1 block">${timeString}</span>
            `;

            wrapper.appendChild(bubble);
            messagesContainer.appendChild(wrapper);

            // Scroll to bottom
            const messagesArea = document.getElementById("messagesArea");
            if (messagesArea) {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
        }

        // Unique Key Modal functions
        function openUniqueKeyModal() {
            document.getElementById("uniqueKeyModal").classList.remove("hidden");
            document.getElementById("uniqueKeyInput").value = "";
            document.getElementById("modalMessage").textContent = "";
        }

        function closeUniqueKeyModal() {
            document.getElementById("uniqueKeyModal").classList.add("hidden");
        }

        async function saveUniqueKey() {
            const uniqueId = document.getElementById("uniqueKeyInput").value.trim();
            const messageEl = document.getElementById("modalMessage");

            if (!uniqueId) {
                messageEl.textContent = "Unique Key is required!";
                messageEl.className = "text-red-400";
                return;
            }

            try {
                const res = await fetch("/save-unique-id", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user: currentUser, unique_id: uniqueId })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        messageEl.textContent = "Changes have been saved.";
                        messageEl.className = "text-green-400";
                        setTimeout(() => closeUniqueKeyModal(), 900);
                    } else {
                        messageEl.textContent = "ID already exists.";
                        messageEl.className = "text-red-400";
                    }
                } else {
                    messageEl.textContent = "Server error.";
                    messageEl.className = "text-red-400";
                }
            } catch (err) {
                messageEl.textContent = "Error saving unique key.";
                messageEl.className = "text-red-400";
                console.error("saveUniqueKey error:", err);
            }
        }

        // Add User Modal functions
        function openAddUserModal() {
            document.getElementById("addUserModal").classList.remove("hidden");
            document.getElementById("addUserMessage").textContent = "";
        }

        function closeAddUserModal() {
            document.getElementById("addUserModal").classList.add("hidden");
        }

        async function connectUser() {
            const username = document.getElementById("newUsername").value.trim();
            const key = document.getElementById("newUserKey").value.trim();
            const messageEl = document.getElementById("addUserMessage");

            if (!username || !key) {
                messageEl.textContent = "Both fields are required.";
                messageEl.className = "text-red-400";
                return;
            }

            try {
                const res = await fetch("/connect-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, key })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        contacts = data;
                        updateContactList(data);
                        closeAddUserModal();
                    } else {
                        messageEl.textContent = "Given data doesn't match any users.";
                        messageEl.className = "text-red-400";
                    }
                } else {
                    messageEl.textContent = "Server error.";
                    messageEl.className = "text-red-400";
                }
            } catch (err) {
                console.error("connectUser error:", err);
                messageEl.textContent = "Error connecting user.";
                messageEl.className = "text-red-400";
            }
        }

        function updateContactList(contacts) {
            renderContacts(contacts);
        }

        function showNotifications() {
            alert("Notification feature coming soon!");
        }

        // Utility function
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
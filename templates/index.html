<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Community Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center items-center">
  <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg flex flex-col h-[90vh]">

    <!-- Header -->
    <div class="px-4 py-3 border-b flex items-center gap-2">
      <button class="text-gray-600 hover:text-gray-900">←</button>
      <h2 class="text-lg font-semibold">Community Chat</h2>
    </div>

    <!-- Messages -->
    <div id="output" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
      <!-- Chat history & live messages will load here -->
    </div>

    <!-- Input -->
    <div class="p-3 border-t flex items-center gap-2">
      <input 
        id="messageInput" 
        type="text" 
        placeholder="Type a message..." 
        class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring focus:ring-blue-300" 
      />
      <button 
        onclick="sendMessage()" 
        class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full">
        ➤
      </button>
    </div>
  </div>

  <!-- Hidden user + chat history -->
  <h2 id="username" class="hidden">{{user}}</h2>
  <script id="chat-data" type="application/json">{{ chat_history | tojson }}</script>

  <script>
    let ws;
    let currentUser;

    window.onload = () => {
      currentUser = document.getElementById("username").innerText.trim();
      if (!currentUser) {
        alert("No user found.");
        return;
      }

      // Load chat history (list of [username, message])
      const historyData = JSON.parse(document.getElementById("chat-data").textContent || "[]");
      historyData.forEach(([sender, message]) => {
        const isOwnMessage = sender === currentUser;
        appendMessage(sender, message, isOwnMessage);
      });

      connect(currentUser);
    };

    function connect(userId) {
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = `${protocol}://${window.location.host}/ws/${userId}`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => console.log("WebSocket connected to", wsUrl);

      ws.onmessage = (event) => {
        const [sender, ...messageParts] = event.data.split(":");
        const messageText = messageParts.join(":").trim();
        const isOwnMessage = sender.trim() === currentUser;
        appendMessage(sender.trim(), messageText, isOwnMessage);
      };
    }

    function sendMessage() {
      const msgInput = document.getElementById("messageInput");
      const msg = msgInput.value.trim();
      if (!msg) return;

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(msg);
        appendMessage(currentUser, msg, true);
        msgInput.value = "";
      } else {
        alert("WebSocket is not connected.");
      }
    }

    function appendMessage(sender, messageText, isOwnMessage) {
      const output = document.getElementById("output");
      const wrapper = document.createElement("div");

      wrapper.className = isOwnMessage 
        ? "flex justify-end gap-2"
        : "flex items-start gap-2";

      const bubble = document.createElement("div");
      bubble.className = isOwnMessage
        ? "bg-blue-600 text-white px-4 py-2 rounded-2xl max-w-sm"
        : "bg-gray-200 px-4 py-2 rounded-2xl max-w-sm";

      bubble.innerHTML = `
        <p class="text-sm ${isOwnMessage ? "" : "text-gray-700"}">
          <span class="font-semibold">${sender}</span>
        </p>
        <p>${messageText}</p>
      `;

      wrapper.appendChild(bubble);
      output.appendChild(wrapper);
      output.scrollTop = output.scrollHeight;
    }
  </script>
</body>
</html>
